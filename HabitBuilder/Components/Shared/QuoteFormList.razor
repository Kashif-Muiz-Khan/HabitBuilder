@using HabitBuilder.Context
@using HabitBuilder.Model
@using Microsoft.AspNetCore.Components.Authorization
@using MudBlazor
@inject QuoteProvider QuoteProvider
@inject NavigationManager NavigationManager
@inject UserProvider UserProvider
@inject AuthenticationStateProvider AuthenticationStateProvider


<div>
    <div class="row g-0">
        <div class="col-md-12">
            <button class="btn btn-primary float-end" @onclick="ShowAddQuote">
                Add Quote
            </button>
        </div>
    </div>

    @if (showForm)
    {
        <div class="card">
            <div class="card-body bg-light">
                <h4 class="card-title">
                    @(model.Id == 0 ? "Add Quote" : "Edit Quote")
                </h4>
                <EditForm OnValidSubmit="Submit" EditContext="editContext">
                    <DataAnnotationsValidator />
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="quoteText" class="form-label">Quote Text</label>
                            <InputText class="form-control" placeholder="Enter the quote" @bind-Value="model.QuoteText" />
                            <ValidationMessage For="@(() => model.QuoteText)" />
                        </div>
                        <div class="col-md-6">
                            <label for="author" class="form-label">Author</label>
                            <InputText class="form-control" placeholder="Enter the author's name" @bind-Value="model.Author" />
                            <ValidationMessage For="@(() => model.Author)" />
                        </div>
                        <div class="col-md-12">
                            <button type="submit" class="btn btn-primary float-end">
                                @(model.Id == 0 ? "Add Quote" : "Edit Quote")
                            </button>
                        </div>
                    </div>
                </EditForm>
            </div>
        </div>
    }
</div>

<div class="container">
    <div class="row">
        @foreach (var quote in quotes.Select((value, index) => new { value, index }))
        {
            <div class="col-md-4 mb-4">
                <div class="card">
                    <div class="card-body centre">
                        <h5 class="card-title">"@quote.value.QuoteText"</h5>
                        <h6 class="card-text">@quote.value.Author</h6>
                        <!-- Favorite button -->
                        <MudIconButton Icon="@GetFavoriteIcon(quote.value.Id)"
                                       Color="Color.Secondary"
                                       aria-label="add to favorite"
                                       OnClick="@(() => ToggleFavorite(quote.value.Id))" />
                    </div>
                </div>
            </div>
            @if ((quote.index + 1) % 3 == 0)
            {
                <div class="row"></div>
            }
        }
    </div>
</div>

<div>
    <div class="row g-0">
        <div class="col-md-12">
            <button class="btn btn-primary float-end" @onclick="ShowQuoteList">
                Show Quote List
            </button>
        </div>
    </div>
    @if (showList)
    {
        <table class="table">
            <thead>
                <tr>
                    <th scope="col">#</th>
                    <th scope="col">Quote Text</th>
                    <th scope="col">Author</th>
                    <th></th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var quote in quotes)
                {
                    <tr>
                        <td>@quote.Id</td>
                        <td>@quote.QuoteText</td>
                        <td>@quote.Author</td>
                        <td>
                            <button class="btn btn-success" @onclick="() => Edit(quote)">Edit</button>
                        </td>
                        <td>
                            <button class="btn btn-danger" @onclick="() => Delete(quote)">Delete</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
</div>

@code {
    private List<Quote> quotes = new();
    private EditContext editContext;
    private Quote model = new();
    private bool showForm;
    private bool showList;
    private User user;

    private async Task ToggleFavorite(int quoteId)
    {
        await QuoteProvider.ToggleFavoriteAsync(quoteId, user);
        await Refresh(); // Refresh the list of quotes after toggling
    }

    private string GetFavoriteIcon(int quoteId)
    {
        var isFavorite = favoriteQuotes.Any(fq => fq.Id == quoteId);
        return isFavorite ? Icons.Material.Filled.Favorite : Icons.Material.Outlined.FavoriteBorder;
    }

    private void ShowQuoteList()
    {
        showList = true;
    }

    private void ShowAddQuote()
    {
        model = new Quote();
        editContext = new EditContext(model);
        showForm = true;
    }

    private void Edit(Quote quote)
    {
        model = quote;
        editContext = new EditContext(model);
        showForm = true;
    }

    private async Task Submit()
    {
        if (model.Id == 0)
        {
            await QuoteProvider.AddQuoteAsync(model); // Add new quote
        }
        else
        {
            await QuoteProvider.UpdateQuoteAsync(model); // Update existing quote
        }

        await Refresh();
        showForm = false; // Hide form after submission
    }

    private async Task Refresh()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var username = authState.User.Identity.Name;
        user = UserProvider.GetUserByUsername(username);
        quotes = await QuoteProvider.GetAllQuotesAsync();
        favoriteQuotes = await QuoteProvider.GetFavoriteQuotesAsync(user);
    }

    private async Task Delete(Quote quote)
    {
        await QuoteProvider.DeleteQuoteAsync(quote);
        await Refresh();
    }

    protected override async Task OnInitializedAsync()
    {
        await Refresh();
    }

    private List<Quote> favoriteQuotes = new(); // List of favorite quotes for the user
}
